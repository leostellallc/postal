<!DOCTYPE html>
<html>
  <head>
    <!-- Do not cache this page -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <script type="text/javascript" src="config.js"></script>

    <!-- TODO: Test newer version of jQuery -->
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.1/jquery-ui.min.js"></script>

    <script type="text/javascript" src="lib/dygraph/dygraph.js"></script>
    <script type="text/javascript" src="lib/dygraph/hairlines.js"></script>
    <script type="text/javascript" src="lib/dygraph-extra/dygraph-extra.js"></script>
    <link rel="stylesheet" href="lib/dygraph/dygraph.css" type="text/css">

    <script type="text/javascript" src="lib/lzma/lzma.js"></script>
    <script type="text/javascript" src="lib/lzma/lzma.shim.js"></script>
    <link rel="stylesheet" href="postal.css" type="text/css">

    <!-- The script with all the logic for creating the plot and managing interactions. -->
    <script type="text/javascript" src="postal.js"></script>

    <!-- Load metadata for the plot. -->
    <script type="text/javascript">
      function help()
      {
          window.open("help/");
      }

      function getUrlParameter(name)
      {
          name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
          const regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
          const results = regex.exec(location.search);
          return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
      }

      /*
       * If this is a share link, get the share ID so we can download the state.
       */
      const g_shareId = getUrlParameter("s");
      var datasetId;
      if (g_shareId != "") {
          /*
           * Load the state then the metadata.
           */
          datasetId = loadState(g_shareId);
          loadMetadata(datasetId);
      } else {
          /*
           * Extract the dataset ID then load the metadata.
           */
          datasetId = getUrlParameter("d");
          loadMetadata(datasetId);
      }
      const g_datasetId = datasetId;
      document.title = "Postal: " + g_datasetId;

      function main()
      {
          if (g_shareId != "") {
              main_with_sharelink();
          } else {
              main_with_dataset(g_datasetId);
          }
      }

      function keypress(event)
      {
          if (event.keyCode == '13') {
              event.preventDefault();
          }
      }
    </script>
  </head>

  <body onload="main();">
    <!-- Annotation template. -->
    <div id="hairline-template" class="hairline-info" style="display:none; cursor: pointer;">
      <div class="hairline-legend unselectable"></div>
    </div>

    <!-- The channel selection bar. -->
    <div class="split left" onmouseleave="refreshSelect(document.getElementById('regex').value)">
      <form autocomplete="off">
        <abbr title="Filter the list of metric by regex">
          <input type="text" id="regex" onkeyup="refreshSelect(this.value)" onkeypress="keypress(event);"><br>
        </abbr>
      </form>
      <div id="select"><!-- Content is generated by script. --></div>
    </div>

    <!-- The main plotting area. -->
    <div class="split right">
      <!-- The menu bar. -->
      <div class="split menu unselectable">
        &nbsp;&nbsp;dataset:
        <script type="text/javascript">
          document.write(g_datasetId);
        </script>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <abbr title="Control placement of the legend (left, right, hidden)">
            <input class="checkbox" type="checkbox" id="legend_left" onclick="showLegend(-1)">
            <input class="checkbox" type="checkbox" id="legend_right" onclick="showLegend(1)" checked>
            legend
          </abbr>
          <abbr title="Emphasize data points">
            <input type="checkbox" id="show_points" onclick="showPoints(this.checked)">
            points
          </abbr>
          <abbr title="Filter by validity">
            <input type="checkbox" id="enable_filter" onclick="enableFilter(this.checked)" checked>
            filter
          </abbr>
          <abbr title="Highlight a series while mouse hovers over it">
            <input type="checkbox" id="enable_highlights" onclick="enableHighlights(this.checked)">
            highlight
          </abbr>
          <abbr title="Display a range selection bar under the plot">
            <input type="checkbox" id="enable_rangesel" onclick="enableRangeSelector(this.checked)">
            range sel.
          </abbr>
          <abbr title="Display user annotations on the plot">
            <input type="checkbox" id="show_annotations" onclick="showAnnotations(this.checked)">
            annotations
          </abbr>
          <abbr title="Allow the dataset to be updated live, disable caching">
            <input type="checkbox" id="is_live" onclick="enableLive(this.checked)">
            live
          </abbr>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          <abbr title="Add an annotation to the plot">
            <input type="button" value="annotate" onclick="annotate()">
          </abbr>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          <abbr title="Create a shareable link of the plot and copy it to the clipboard">
            <input type="button" value="share link" onclick="share()">
          </abbr>
          <abbr title="Download an export of the plot as a PNG image">
            <input type="button" value="to PNG" onclick="downloadPNG()">
          </abbr>
          <abbr title="Download an export of the plot as a CSV spreadsheet">
            <input type="button" value="to CSV" onclick="exportCSV()">
          </abbr>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          <abbr title="Zoom out">
            <input type="button" value="zoom out" onclick="zoomout()">
          </abbr>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <abbr title="Toggle stacking of the Y2 plots above the Y plots">
            <input type="button" value="stack plots" onclick="stack()">
          </abbr>
          <span style="float:right;">
            <input type="button" value="help!" onclick="help()">
            &nbsp;&nbsp;&nbsp;&nbsp;
          </span>
      </div>
      <!-- This is the actual drawing area for Dygraph. -->
      <div class="graph" id="graph"></div>
      <div id="cover-spin"></div>
    </div>
  </body>
</html>
